

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Pipelines Demo &mdash; DACKAR 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Semantic Similarity Analysis" href="test_synset_similarity.html" />
    <link rel="prev" title="Abbreviation Handler Demo" href="abbreviationHandlerDemo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            DACKAR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install_spacy3.5.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="PreprocessingDemo.html">Preprocessing Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="abbreviationHandlerDemo.html">Abbreviation Handler Demo</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Pipelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Internal-Developed-Functions">Internal Developed Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Internal-Developed-Pipelines">Internal Developed Pipelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Reset-NLP-Pipeline">Reset NLP Pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="test_synset_similarity.html">Similarity Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="alias_demo.html">NLP Alias Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="ER_schema_functionality_test.html">ER Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="LML_functionality_test.html">MBSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="RuleBasedNLP.html">Rule-based NLP</a></li>
<li class="toctree-l2"><a class="reference internal" href="Workflow_Demo.html">Workflow Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="WorkOrderProcessing.html">Work Order Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_anomalies.html">Anomaly Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="DACKAR_KG_NLP_Demo.html">Knowledge Graph Demo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge_graph.html">Knowledge Graph Construction Through Neo4j</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DACKAR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Usage Notebooks</a></li>
      <li class="breadcrumb-item active">Custom Pipelines Demo</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/nlp_custom_pipes.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Custom-Pipelines-Demo">
<h1>Custom Pipelines Demo<a class="headerlink" href="#Custom-Pipelines-Demo" title="Link to this heading">¶</a></h1>
<ul class="simple">
<li><p>normEntities: Normalizing Named Entities, remove the leading article and trailing particle</p></li>
<li><p>initCoref: Initialize Coreference Attributes with Entity Info</p></li>
<li><p>anaphorCoref: Anaphora resolution using coreferee</p></li>
<li><p>expandEntities: Expand the current entities, recursive function to extend entity with all previous NOUN</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd
import spacy
from spacy.tokens import Span
from spacy.language import Language
from spacy.matcher import Matcher
from spacy.tokens import Token
from spacy import displacy
import coreferee

#### Using spacy&#39;s Token extensions for coreferee
if Token.has_extension(&#39;ref_n&#39;):
  _ = Token.remove_extension(&#39;ref_n&#39;)
if Token.has_extension(&#39;ref_t&#39;):
  _ = Token.remove_extension(&#39;ref_t&#39;)
if Token.has_extension(&#39;ref_t_&#39;):
  _ = Token.remove_extension(&#39;ref_t_&#39;)
Token.set_extension(&#39;ref_n&#39;, default=&#39;&#39;)
Token.set_extension(&#39;ref_t&#39;, default=&#39;&#39;)

nlp = spacy.load(&quot;en_core_web_lg&quot;)
</pre></div>
</div>
</div>
<section id="Internal-Developed-Functions">
<h2>Internal Developed Functions<a class="headerlink" href="#Internal-Developed-Functions" title="Link to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Function used to display NER entities
def displayNER(doc, includePunct=False):
  &quot;&quot;&quot;
    Generate data frame for visualization of spaCy doc with custom attributes.
  &quot;&quot;&quot;
  rows = []
  for i, t in enumerate(doc):
    if not t.is_punct or includePunct:
      row = {&#39;token&#39;: i,
             &#39;text&#39;: t.text, &#39;lemma&#39;: t.lemma_,
             &#39;pos&#39;: t.pos_, &#39;dep&#39;: t.dep_, &#39;ent_type&#39;: t.ent_type_,
             &#39;ent_iob_&#39;: t.ent_iob_}
      if doc.has_extension(&#39;coref_chains&#39;):
        if t.has_extension(&#39;coref_chains&#39;) and t._.coref_chains: # neuralcoref attributes
          row[&#39;coref_chains&#39;] = t._.coref_chains.pretty_representation
        else:
          row[&#39;coref_chains&#39;] = None
      if t.has_extension(&#39;ref_n&#39;): # referent attribute
        row[&#39;ref_n&#39;] = t._.ref_n
        row[&#39;ref_t&#39;] = t._.ref_t
      if t.has_extension(&#39;ref_ent&#39;): # ref_n/ref_t
        row[&#39;ref_ent&#39;] = t._.ref_ent
      rows.append(row)
  df = pd.DataFrame(rows).set_index(&#39;token&#39;)
  df.index.name = None
  return df


# Reset Pipelines
def resetPipeline(nlp, pipes):
  &quot;&quot;&quot;
    remove all custom pipes, and add new pipes
  &quot;&quot;&quot;
  customPipes = [pipe for (pipe, _) in nlp.pipeline
                  if pipe not in [&#39;tagger&#39;, &#39;parser&#39;,
                                  &#39;tok2vec&#39;, &#39;attribute_ruler&#39;, &#39;lemmatizer&#39;]]
  for pipe in customPipes:
    _ = nlp.remove_pipe(pipe)
  # re-add specified pipes
  for pipe in pipes:
    nlp.add_pipe(pipe)

# Print Dependency Tree
def printDepTree(doc, skipPunct=True):
  &quot;&quot;&quot;
    Utility function to pretty print the dependency tree.
  &quot;&quot;&quot;
  def printRecursive(root, indent, skipPunct):
    if not root.dep_ == &#39;punct&#39; or not skipPunct:
      print(&quot; &quot;*indent + f&quot;{root} [{root.pos_}, {root.dep_}]&quot;)
    for left in root.lefts:
      printRecursive(left, indent=indent+4, skipPunct=skipPunct)
    for right in root.rights:
      printRecursive(right, indent=indent+4, skipPunct=skipPunct)

  for sent in doc.sents: # iterate over all sentences in a doc
    printRecursive(sent.root, indent=0, skipPunct=skipPunct)
</pre></div>
</div>
</div>
<section id="Internal-Developed-Pipelines">
<h3>Internal Developed Pipelines<a class="headerlink" href="#Internal-Developed-Pipelines" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Normalizing Named Entities, remove the leading article and trailing particle
@Language.component(&quot;normEntities&quot;)
def normEntities(doc):
  &quot;&quot;&quot;
    Normalizing Named Entities, remove the leading article and trailing particle
    @ In, doc, spacy.tokens.doc.Doc
    @ Out, doc, spacy.tokens.doc.Doc
  &quot;&quot;&quot;
  ents = []
  for ent in doc.ents:
    if ent[0].pos_ == &quot;DET&quot;: # leading article
      ent = Span(doc, ent.start+1, ent.end, label=ent.label)
    if len(ent) &gt; 0:
      if ent[-1].pos_ == &quot;PART&quot;: # trailing particle like &#39;s
        ent = Span(doc, ent.start, ent.end-1, label=ent.label)
      if len(ent) &gt; 0:
        ents.append(ent)
  doc.ents = tuple(ents)
  return doc

# Initialize Coreference Attributes with Entity Info
@Language.component(&quot;initCoref&quot;)
def initCoref(doc):
  for e in doc.ents:
    e[0]._.ref_n, e[0]._.ref_t = e.text, e.label_
  return doc

# Anaphora resolution using coreferee
@Language.component(&quot;anaphorCoref&quot;)
def anaphorCoref(doc):
  &quot;&quot;&quot;
    Anaphora resolution using coreferee
    This pipeline need to be added after NER.
    The assumption here is: The entities need to be recognized first, then call
    pipeline &quot;initCoref&quot; to assign initial custom attribute &quot;ref_n&quot; and &quot;ref_t&quot;,
    then call pipeline &quot;aliasResolver&quot; to resolve all the aliases used in the text.
    After all these pre-processes, we can use &quot;anaphorCoref&quot; pipeline to resolve the
    coreference.
  &quot;&quot;&quot;
  if not Token.has_extension(&#39;coref_chains&#39;):
    return doc
  for token in doc:
    coref = token._.coref_chains
    # if token is coref and not already dereferenced
    if coref and token._.ref_n == &#39;&#39;:
      # check all the references, if &quot;ref_n&quot; is available (determined by NER and initCoref),
      # the value of &quot;ref_n&quot; will be assigned to current token
      for chain in coref:
        for ref in chain:
          refToken = doc[ref[0]]
          if refToken._.ref_n != &#39;&#39;:
            token._.ref_n = refToken._.ref_n
            token._.ref_t = refToken._.ref_t
            break
  return doc

# Expand the current entities, recursive function to extend entity with all previous NOUN
@Language.component(&quot;expandEntities&quot;)
def expandEntities(doc):
  &quot;&quot;&quot;
    Expand the current entities, recursive function to extend entity with all previous NOUN
  &quot;&quot;&quot;
  newEnts = []
  isUpdated = False
  for ent in doc.ents:
    if ent.label_ == &quot;SSC&quot; and ent.start != 0:
      prevToken = doc[ent.start - 1]
      if prevToken.pos_ in [&#39;NOUN&#39;]:
        newEnt = Span(doc, ent.start - 1, ent.end, label=ent.label)
        newEnts.append(newEnt)
        isUpdated = True
    else:
      newEnts.append(ent)
  doc.ents = newEnts
  if isUpdated:
    doc = expandEntities(doc)
  return doc
</pre></div>
</div>
</div>
</section>
</section>
<section id="Reset-NLP-Pipeline">
<h2>Reset NLP Pipeline<a class="headerlink" href="#Reset-NLP-Pipeline" title="Link to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pipelines = [&#39;entity_ruler&#39;,&#39;normEntities&#39;, &#39;initCoref&#39;, &#39;coreferee&#39;,&#39;anaphorCoref&#39;, &#39;expandEntities&#39;]
resetPipeline(nlp, pipelines)
nlp.pipeline
</pre></div>
</div>
</div>
</section>
<section id="Example">
<h2>Example<a class="headerlink" href="#Example" title="Link to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>text = r&quot;&quot;&quot;A leak was noticed from the RCP pump 1A.
          The RCP pump 1A pressure gauge was found not operating, and it was found inoperative.
          The RCP pump 1A pressure gauge was found inoperative.
          Rupture of pump bearings caused shaft degradation.
          Rupture of pump bearings caused shaft degradation and consequent flow reduction.
          Pump power supply has been found burnout.
          Pump test failed due to power supply failure.
          Pump inspection revealed excessive impeller degradation.
          Pump inspection revealed excessive impeller degradation likely due to cavitation.
        &quot;&quot;&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>patterns = [{&quot;label&quot;:&quot;comp&quot;, &quot;pattern&quot;:[{&quot;LOWER&quot;:&quot;gauge&quot;}], &quot;id&quot;:&quot;ssc&quot;}]
ruler = nlp.get_pipe(&#39;entity_ruler&#39;)
ruler.add_patterns(patterns)
rules = [{&quot;LOWER&quot;:&quot;pump&quot;}]
matcher = Matcher(nlp.vocab)
matcher.add(&#39;comp&#39;, [rules])

doc = nlp(text)
matches = matcher(doc, as_spans=True)
print(&#39;Identified Entities:&#39;)
for span in matches:
    print(&#39;Entity:&#39;, span.text, &#39;| Label:&#39;, span.label_, &#39;| Sentence&#39;, span.sent)

displacy.render(doc, style=&#39;ent&#39;, jupyter=True)

print(&#39;Dependency Tree:&#39;)
printDepTree(doc)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df = displayNER(doc)
df
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&#39;Coreference Info: \n&#39;, doc._.coref_chains.pretty_representation)

print(f&#39;Label for token &quot;{doc[22]}&quot; is &quot;{doc[22]._.ref_n}&quot;&#39;)
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="abbreviationHandlerDemo.html" class="btn btn-neutral float-left" title="Abbreviation Handler Demo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="test_synset_similarity.html" class="btn btn-neutral float-right" title="Semantic Similarity Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright 2024, Battelle Energy Alliance, LLC  ALL RIGHTS RESERVED.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>