<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom pipelines &mdash; DACKAR 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Similarity analysis" href="test_synset_similarity.html" />
    <link rel="prev" title="Abbreviation handler demo" href="abbreviationHandlerDemo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            DACKAR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install_spacy3.5.html">Installation with Spacy 3.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation with Spacy 3.1 (Archived)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="PreprocessingDemo.html">Preprocessing demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="PreprocessingDemo.html#Coherent-text-example-with-Autocorrect-and-ContextualSpellCheck-spelling-correction">Coherent text example with Autocorrect and ContextualSpellCheck spelling correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="PreprocessingDemo.html#Time-Autocorrect-workflow">Time Autocorrect workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="PreprocessingDemo.html#Time-ContextualSpellCheck-workflow">Time ContextualSpellCheck workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="Workflow_Demo.html">Workflow Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="abbreviationHandlerDemo.html">Abbreviation Handler Demo</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_synset_similarity.html">Similarity Demo</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DACKAR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Usage Notebooks</a></li>
      <li class="breadcrumb-item active">Custom pipelines</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/nlp_custom_pipes.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd
import spacy
from spacy.tokens import Span
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def displayNER(doc, includePunct=False):
  &quot;&quot;&quot;
    Generate data frame for visualization of spaCy doc with custom attributes.
  &quot;&quot;&quot;
  rows = []
  for i, t in enumerate(doc):
    if not t.is_punct or includePunct:
      row = {&#39;token&#39;: i,
             &#39;text&#39;: t.text, &#39;lemma&#39;: t.lemma_,
             &#39;pos&#39;: t.pos_, &#39;dep&#39;: t.dep_, &#39;ent_type&#39;: t.ent_type_,
             &#39;ent_iob_&#39;: t.ent_iob_}
      if doc.has_extension(&#39;coref_chains&#39;):
        if t.has_extension(&#39;coref_chains&#39;) and t._.coref_chains: # neuralcoref attributes
          row[&#39;coref_chains&#39;] = t._.coref_chains.pretty_representation
        else:
          row[&#39;coref_chains&#39;] = None
      if t.has_extension(&#39;ref_n&#39;): # referent attribute
        row[&#39;ref_n&#39;] = t._.ref_n
        row[&#39;ref_t&#39;] = t._.ref_t
      if t.has_extension(&#39;ref_ent&#39;): # ref_n/ref_t
        row[&#39;ref_ent&#39;] = t._.ref_ent
      rows.append(row)
  df = pd.DataFrame(rows).set_index(&#39;token&#39;)
  df.index.name = None

  return df
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def resetPipeline(nlp, pipes):
  &quot;&quot;&quot;
    remove all custom pipes, and add new pipes
  &quot;&quot;&quot;
  customPipes = [pipe for (pipe, _) in nlp.pipeline
                  if pipe not in [&#39;tagger&#39;, &#39;parser&#39;,
                                  &#39;tok2vec&#39;, &#39;attribute_ruler&#39;, &#39;lemmatizer&#39;]]
  for pipe in customPipes:
    _ = nlp.remove_pipe(pipe)
  # re-add specified pipes
  for pipe in pipes:
    nlp.add_pipe(pipe)
  logger.info(f&quot;Model: {nlp.meta[&#39;name&#39;]}, Language: {nlp.meta[&#39;lang&#39;]}&quot;)
  logger.info(&#39;\n&#39;.join([pipe for (pipe,_) in nlp.pipeline]))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def printDepTree(doc, skipPunct=True):
  &quot;&quot;&quot;
    Utility function to pretty print the dependency tree.
  &quot;&quot;&quot;
  def printRecursive(root, indent, skipPunct):
    if not root.dep_ == &#39;punct&#39; or not skipPunct:
      print(&quot; &quot;*indent + f&quot;{root} [{root.pos_}, {root.dep_}]&quot;)
    for left in root.lefts:
      printRecursive(left, indent=indent+4, skipPunct=skipPunct)
    for right in root.rights:
      printRecursive(right, indent=indent+4, skipPunct=skipPunct)

  for sent in doc.sents: # iterate over all sentences in a doc
    printRecursive(sent.root, indent=0, skipPunct=skipPunct)
</pre></div>
</div>
</div>
<section id="Custom-pipelines">
<h1>Custom pipelines<a class="headerlink" href="#Custom-pipelines" title="Link to this heading">Â¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from spacy.language import Language
from spacy.tokens import Span
from spacy.matcher import Matcher
from spacy.tokens import Token
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>customLabel = [&#39;STRUCTURE&#39;, &#39;COMPONENT&#39;, &#39;SYSTEM&#39;]
aliasLookup = {}
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@Language.component(&quot;normEntities&quot;)
def normEntities(doc):
  &quot;&quot;&quot;
    Normalizing Named Entities, remove the leading article and trailing particle
    @ In, doc, spacy.tokens.doc.Doc
    @ Out, doc, spacy.tokens.doc.Doc
  &quot;&quot;&quot;
  ents = []
  for ent in doc.ents:
    if ent[0].pos_ == &quot;DET&quot;: # leading article
      ent = Span(doc, ent.start+1, ent.end, label=ent.label)
    if len(ent) &gt; 0:
      if ent[-1].pos_ == &quot;PART&quot;: # trailing particle like &#39;s
        ent = Span(doc, ent.start, ent.end-1, label=ent.label)
      if len(ent) &gt; 0:
        ents.append(ent)
  doc.ents = tuple(ents)
  return doc
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@Language.component(&quot;initCoref&quot;)
def initCoref(doc):
  for e in doc.ents:
    # if e.label_ in customLabel:
      e[0]._.ref_n, e[0]._.ref_t = e.text, e.label_
  return doc
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@Language.component(&quot;aliasResolver&quot;)
def aliasResolver(doc):
  &quot;&quot;&quot;
    Lookup aliases and store result in ref_t, ref_n
  &quot;&quot;&quot;
  for ent in doc.ents:
    token = ent[0].text
    if token in aliasLookup:
      aName, aType = aliasLookup[token]
      ent[0]._.ref_n, ent[0]._.ref_t = aName, aType
  return propagateEntType(doc)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def propagateEntType(doc):
  &quot;&quot;&quot;
    propagate entity type stored in ref_t
  &quot;&quot;&quot;
  ents = []
  for e in doc.ents:
    if e[0]._.ref_n != &#39;&#39;: # if e is a coreference
      e = Span(doc, e.start, e.end, label=e[0]._.ref_t)
    ents.append(e)
  doc.ents = tuple(ents)
  return doc
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@Language.component(&quot;anaphorCoref&quot;)
def anaphorCoref(doc):
  &quot;&quot;&quot;
    Anaphora resolution using coreferee
    This pipeline need to be added after NER.
    The assumption here is: The entities need to be recognized first, then call
    pipeline &quot;initCoref&quot; to assign initial custom attribute &quot;ref_n&quot; and &quot;ref_t&quot;,
    then call pipeline &quot;aliasResolver&quot; to resolve all the aliases used in the text.
    After all these pre-processes, we can use &quot;anaphorCoref&quot; pipeline to resolve the
    coreference.
  &quot;&quot;&quot;
  if not Token.has_extension(&#39;coref_chains&#39;):
    return doc
  for token in doc:
    coref = token._.coref_chains
    # if token is coref and not already dereferenced
    if coref and token._.ref_n == &#39;&#39;:
      # check all the references, if &quot;ref_n&quot; is available (determined by NER and initCoref),
      # the value of &quot;ref_n&quot; will be assigned to current totken
      for chain in coref:
        for ref in chain:
          refToken = doc[ref[0]]
          if refToken._.ref_n != &#39;&#39;:
            token._.ref_n = refToken._.ref_n
            token._.ref_t = refToken._.ref_t
            break
  return doc
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@Language.component(&quot;expandEntities&quot;)
def expandEntities(doc):
  &quot;&quot;&quot;
    Expand the current entities, recursive function to extend entity with all previous NOUN
  &quot;&quot;&quot;
  newEnts = []
  isUpdated = False
  for ent in doc.ents:
    if ent.label_ == &quot;SSC&quot; and ent.start != 0:
      prevToken = doc[ent.start - 1]
      if prevToken.pos_ in [&#39;NOUN&#39;]:
        newEnt = Span(doc, ent.start - 1, ent.end, label=ent.label)
        newEnts.append(newEnt)
        isUpdated = True
    else:
      newEnts.append(ent)
  doc.ents = newEnts
  if isUpdated:
    doc = expandEntities(doc)
  return doc
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import coreferee, spacy
nlp = spacy.load(&quot;en_core_web_lg&quot;)
import logging
logger = logging.getLogger(__name__)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ch = logging.StreamHandler()
logger.addHandler(ch)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#### Using spacy&#39;s Token extensions for coreferee
if Token.has_extension(&#39;ref_n&#39;):
  _ = Token.remove_extension(&#39;ref_n&#39;)
if Token.has_extension(&#39;ref_t&#39;):
  _ = Token.remove_extension(&#39;ref_t&#39;)
if Token.has_extension(&#39;ref_t_&#39;):
  _ = Token.remove_extension(&#39;ref_t_&#39;)
Token.set_extension(&#39;ref_n&#39;, default=&#39;&#39;)
Token.set_extension(&#39;ref_t&#39;, default=&#39;&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pipelines = [&#39;entity_ruler&#39;,&#39;normEntities&#39;, &#39;initCoref&#39;, &#39;aliasResolver&#39;, &#39;coreferee&#39;,&#39;anaphorCoref&#39;, &#39;expandEntities&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pipelines
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;entity_ruler&#39;,
 &#39;normEntities&#39;,
 &#39;initCoref&#39;,
 &#39;aliasResolver&#39;,
 &#39;coreferee&#39;,
 &#39;anaphorCoref&#39;,
 &#39;expandEntities&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>resetPipeline(nlp, pipelines)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nlp.pipeline
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;tok2vec&#39;, &lt;spacy.pipeline.tok2vec.Tok2Vec at 0x128033a70&gt;),
 (&#39;tagger&#39;, &lt;spacy.pipeline.tagger.Tagger at 0x128033470&gt;),
 (&#39;parser&#39;, &lt;spacy.pipeline.dep_parser.DependencyParser at 0x123e4e810&gt;),
 (&#39;attribute_ruler&#39;,
  &lt;spacy.pipeline.attributeruler.AttributeRuler at 0x1282128d0&gt;),
 (&#39;lemmatizer&#39;, &lt;spacy.lang.en.lemmatizer.EnglishLemmatizer at 0x12815f4d0&gt;),
 (&#39;entity_ruler&#39;, &lt;spacy.pipeline.entityruler.EntityRuler at 0x127eb2310&gt;),
 (&#39;normEntities&#39;, &lt;function __main__.normEntities(doc)&gt;),
 (&#39;initCoref&#39;, &lt;function __main__.initCoref(doc)&gt;),
 (&#39;aliasResolver&#39;, &lt;function __main__.aliasResolver(doc)&gt;),
 (&#39;coreferee&#39;, &lt;coreferee.manager.CorefereeBroker at 0x12a781a90&gt;),
 (&#39;anaphorCoref&#39;, &lt;function __main__.anaphorCoref(doc)&gt;),
 (&#39;expandEntities&#39;, &lt;function __main__.expandEntities(doc)&gt;)]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>text = r&quot;&quot;&quot;A leak was noticed from the RCP pump 1A.
          The RCP pump 1A pressure gauge was found not operating, and it was found inoperative.
          The RCP pump 1A pressure gauge was found inoperative.
          Rupture of pump bearings caused shaft degradation.
          Rupture of pump bearings caused shaft degradation and consequent flow reduction.
          Pump power supply has been found burnout.
          Pump test failed due to power supply failure.
          Pump inspection revealed excessive impeller degradation.
          Pump inspection revealed excessive impeller degradation likely due to cavitation.
        &quot;&quot;&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>patterns = [{&quot;label&quot;:&quot;comp&quot;, &quot;pattern&quot;:[{&quot;LOWER&quot;:&quot;gauge&quot;}], &quot;id&quot;:&quot;ssc&quot;}]
ruler = nlp.get_pipe(&#39;entity_ruler&#39;)
ruler.add_patterns(patterns)
rules = [{&quot;LOWER&quot;:&quot;pump&quot;}]
from spacy.matcher import Matcher
matcher = Matcher(nlp.vocab)
matcher.add(&#39;comp&#39;, [rules])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>doc = nlp(text)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>matches = matcher(doc, as_spans=True)
for span in matches:
    print(span.sent, span.label_)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
A leak was noticed from the RCP pump 1A.
          The RCP pump 1A pressure gauge was found not operating, and it was found inoperative.
           comp
A leak was noticed from the RCP pump 1A.
          The RCP pump 1A pressure gauge was found not operating, and it was found inoperative.
           comp
The RCP pump 1A pressure gauge was found inoperative.
           comp
Rupture of pump bearings caused shaft degradation.
           comp
Rupture of pump bearings caused shaft degradation and consequent flow reduction.
           comp
Pump power supply has been found burnout.
           comp
Pump test failed due to power supply failure.
           comp
Pump inspection revealed excessive impeller degradation.
           comp
Pump inspection revealed excessive impeller degradation likely due to cavitation.
         comp
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(type(doc.ents))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;tuple&#39;&gt;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from spacy import displacy
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>displacy.render(doc, style=&#39;ent&#39;, jupyter=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">A leak was noticed from the RCP pump 1A.</br>          The RCP pump 1A pressure
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    gauge
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">comp</span>
</mark>
 was found not operating, and it was found inoperative.</br>          The RCP pump 1A pressure
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    gauge
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">comp</span>
</mark>
 was found inoperative.</br>          Rupture of pump bearings caused shaft degradation.</br>          Rupture of pump bearings caused shaft degradation and consequent flow reduction.</br>          Pump power supply has been found burnout.</br>          Pump test failed due to power supply failure.</br>          Pump inspection revealed excessive impeller degradation.</br>          Pump inspection revealed excessive impeller degradation likely due to cavitation.</br>        </div></span></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>patterns = [{&quot;label&quot;:&quot;comp&quot;, &quot;pattern&quot;:[{&quot;LOWER&quot;:&quot;pressure gauge&quot;}, {&quot;POS&quot;:&quot;NOUN&quot;}], &quot;id&quot;:&quot;ssc&quot;}]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>printDepTree(doc)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
noticed [VERB, ROOT]
    leak [NOUN, nsubjpass]
        A [DET, det]
    was [AUX, auxpass]
    from [ADP, prep]
        RCP [PROPN, pobj]
            the [DET, det]
    pump [VERB, conj]
        1A. [NUM, dobj]

           [SPACE, dep]
            pump [VERB, relcl]
                RCP [PROPN, nsubj]
                    The [DET, det]
        found [VERB, conj]
            gauge [NOUN, nsubjpass]
                1A [NOUN, compound]
                pressure [NOUN, compound]
            was [AUX, auxpass]
            operating [VERB, xcomp]
                not [PART, neg]
    and [CCONJ, cc]
    found [VERB, conj]
        it [PRON, nsubjpass]
        was [AUX, auxpass]
        inoperative [ADJ, oprd]

           [SPACE, dep]
pump [VERB, ROOT]
    RCP [PROPN, nsubj]
        The [DET, det]
    found [VERB, conj]
        gauge [NOUN, nsubjpass]
            1A [NOUN, compound]
            pressure [NOUN, compound]
        was [AUX, auxpass]
        inoperative [ADJ, oprd]

           [SPACE, dep]
caused [VERB, ROOT]
    Rupture [NOUN, nsubj]
        of [ADP, prep]
            bearings [NOUN, pobj]
                pump [NOUN, compound]
    degradation [NOUN, dobj]
        shaft [NOUN, compound]

           [SPACE, dep]
caused [VERB, ROOT]
    Rupture [NOUN, nsubj]
        of [ADP, prep]
            bearings [NOUN, pobj]
                pump [NOUN, compound]
    degradation [NOUN, dobj]
        shaft [NOUN, compound]
        and [CCONJ, cc]
        reduction [NOUN, conj]
            flow [NOUN, compound]
                consequent [ADJ, amod]

           [SPACE, dep]
found [VERB, ROOT]
    supply [NOUN, nsubjpass]
        Pump [NOUN, compound]
        power [NOUN, compound]
    has [AUX, aux]
    been [AUX, auxpass]
    burnout [NOUN, oprd]

           [SPACE, dep]
failed [VERB, ROOT]
    test [NOUN, nsubj]
        Pump [NOUN, compound]
    due [ADP, prep]
        to [ADP, pcomp]
        failure [NOUN, pobj]
            supply [NOUN, compound]
                power [NOUN, compound]

           [SPACE, dep]
revealed [VERB, ROOT]
    inspection [NOUN, nsubj]
        Pump [NOUN, compound]
    degradation [NOUN, dobj]
        excessive [ADJ, amod]
        impeller [NOUN, compound]

           [SPACE, dep]
revealed [VERB, ROOT]
    inspection [NOUN, nsubj]
        Pump [NOUN, compound]
    degradation [NOUN, dobj]
        excessive [ADJ, amod]
        impeller [NOUN, compound]
    likely [ADV, ccomp]
        due [ADP, prep]
            to [ADP, pcomp]
            cavitation [NOUN, pobj]

         [SPACE, dep]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df = displayNER(doc)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>lemma</th>
      <th>pos</th>
      <th>dep</th>
      <th>ent_type</th>
      <th>ent_iob_</th>
      <th>coref_chains</th>
      <th>ref_n</th>
      <th>ref_t</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
      <td>a</td>
      <td>DET</td>
      <td>det</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>leak</td>
      <td>leak</td>
      <td>NOUN</td>
      <td>nsubjpass</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>was</td>
      <td>be</td>
      <td>AUX</td>
      <td>auxpass</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>noticed</td>
      <td>notice</td>
      <td>VERB</td>
      <td>ROOT</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>4</th>
      <td>from</td>
      <td>from</td>
      <td>ADP</td>
      <td>prep</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>94</th>
      <td>likely</td>
      <td>likely</td>
      <td>ADV</td>
      <td>ccomp</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>95</th>
      <td>due</td>
      <td>due</td>
      <td>ADP</td>
      <td>prep</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>96</th>
      <td>to</td>
      <td>to</td>
      <td>ADP</td>
      <td>pcomp</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>97</th>
      <td>cavitation</td>
      <td>cavitation</td>
      <td>NOUN</td>
      <td>pobj</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>99</th>
      <td>\n</td>
      <td>\n</td>
      <td>SPACE</td>
      <td>dep</td>
      <td></td>
      <td>O</td>
      <td>None</td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>
<p>91 rows Ã 9 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>doc._.coref_chains.pretty_representation
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;0: RCP(6), RCP(11), RCP(29); 1: gauge(15), it(22)&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for ent in doc.ents:
    print(ent)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gauge
gauge
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>doc[22]._.ref_n
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;gauge&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for token in doc:
    coref = token._.coref_chains

    # if token is coref and not already dereferenced
    if coref and token._.ref_n == &#39;&#39;:
      print(&#39;token&#39;, token)
      # print(token,coref.pretty_representation)
      # check all the references, if &quot;ref_n&quot; is available (determined by NER and initCoref),
      # the value of &quot;ref_n&quot; will be assigned to current totken
      for chain in coref:
        for ref in chain:
          refToken = doc[ref[0]]
          print(refToken)
          print(refToken._.ref_n)
          if refToken._.ref_n != &#39;&#39;:
            token._.ref_n = refToken._.ref_n
            token._.ref_t = refToken._.ref_t
            break
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
token RCP
RCP

RCP

RCP

token RCP
RCP

RCP

RCP

token RCP
RCP

RCP

RCP

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import spacy
from spacy.matcher import Matcher
matcher = Matcher(nlp.vocab)
pattern = [{&quot;LOWER&quot;: &quot;hello&quot;}, {&quot;IS_PUNCT&quot;: True}, {&quot;LOWER&quot;: &quot;world&quot;}]
matcher.add(&quot;HelloWorld&quot;, [pattern])
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>matcher.get(&#39;HelloWorld&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(None, [[{&#39;LOWER&#39;: &#39;hello&#39;}, {&#39;IS_PUNCT&#39;: True}, {&#39;LOWER&#39;: &#39;world&#39;}]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>doc.ents
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(gauge, gauge)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sl = []
for ent in doc.ents:
    sent = ent.sent
    if sent not in sl:
        sl.append(sent)
print(sl)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[A leak was noticed from the RCP pump 1A.
          The RCP pump 1A pressure gauge was found not operating, and it was found inoperative.
          , The RCP pump 1A pressure gauge was found inoperative.
          ]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for sent in sl:
    print(sent.ents)
    print(set(sent.ents))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[gauge]
{gauge}
[gauge]
{gauge}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for sent in sl:
    print(sent.root)
    for token in sent:
        print(token.dep_)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
noticed
det
nsubjpass
auxpass
ROOT
prep
det
pobj
conj
dobj
dep
det
nsubj
relcl
compound
compound
nsubjpass
auxpass
conj
neg
xcomp
punct
cc
nsubjpass
auxpass
conj
oprd
punct
dep
pump
det
nsubj
ROOT
compound
compound
nsubjpass
auxpass
conj
oprd
punct
dep
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="abbreviationHandlerDemo.html" class="btn btn-neutral float-left" title="Abbreviation handler demo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="test_synset_similarity.html" class="btn btn-neutral float-right" title="Similarity analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright 2024, Battelle Energy Alliance, LLC  ALL RIGHTS RESERVED.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>